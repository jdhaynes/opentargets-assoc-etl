# Open Targets Disease-Target Association ETL Pipeline
A simple extract-transform-load (ETL) pipeline to compute disease-target association metrics from publicly available EMBL-EBI Open Targets data.

## Description
This pipeline downloads disease-target association data, disease metadata and target metadata from the EMBL-EBI Open Targets public data hosted on the EMBL-EBI public FTP server in partitioned JSON. Downloads are performed in parallel using multiprocessing for enhanced performance. The data is then loaded into memory and manipulated as a DataFrame (`pandas`) to compute the median and top 3 scores for each disease-target association. The resulting data is saved as a JSON file to the data output directory.

For space, only the output files are committed to this repo.


## Installation
### Option 1: Python Virtual Environment
#### Requirements:
* Python 3.9
* Git
* Venv

Clone this repo and create a new Python virtual environment with `venv`. In the environment, install the required Python dependencies from `requirements.txt` with `pip`:

```{bash}
git clone https://github.com/jdhaynes/opentargets-assoc-etl
cd opentargets-assoc-etl
python3 -m venv env
source env/bin/activate
pip install -r requirements.txt
```

### Option 2: Docker Container
#### Requirements:
* Docker

Pull the image from Docker Hub:
```{bash}
docker pull jackhaynes/opentargets-assoc-etl
```

Alternatively, build the image from source in the repo root directory:

```{bash}
docker build -t jackhaynes/opentargets-assoc-etl .
```

## Executing Pipeline
### Option 1: Python Virtual Environment
First, activate the virtual environment:
```{bash}
source env/bin/activate
```

Then run the pipeline with the following command in the repo root directory with the required arguments:
```{bash}
source env/bin/activate
python etl/run.py \
    --ftp-server ftp.ebi.ac.uk \
    --assoc-dir pub/databases/opentargets/platform/21.11/output/etl/json/evidence/sourceId=eva/ \
    --disease-dir pub/databases/opentargets/platform/21.11/output/etl/json/diseases/ \
    --target-dir pub/databases/opentargets/platform/21.11/output/etl/json/targets/ \
    --output-dir ./data \
    --processes 4
```

The output data can be found in the directory specified by `--output-dir`.

### Option 2: Docker Container
First, create a Docker volume to store data generated by the pipeline:

```{bash}
docker volume create opentargets-assoc-etl-vol
```

Then run the pipeline by starting a new container and passing the required arguments:

```{bash}
docker run -it -v opentargets-assoc-etl-vol:/data jackhaynes/opentargets-assoc-etl \
    --ftp-server ftp.ebi.ac.uk \
    --assoc-dir pub/databases/opentargets/platform/21.11/output/etl/json/evidence/sourceId=eva/ \
    --disease-dir pub/databases/opentargets/platform/21.11/output/etl/json/diseases/ \
    --target-dir pub/databases/opentargets/platform/21.11/output/etl/json/targets/ \
    --output-dir /data \
    --processes 4
```

The output data can be found in the Docker volume `opentargets-assoc-etl-vol`.

### Pipeline Arguments
The following arguments are required by the main Python script `run.py`:

| Argument      | Description                                                                 |
|---------------|-----------------------------------------------------------------------------|
| --ftp-server  | The address of the EMBL-EBI FTP server.                                     |
| --assoc-dir   | Directory on the FTP server containing disease-target association data.     |
| --disease-dir | Directory on the FTP server containing disease data.                        |
| --target-dir  | Directory on the FTP server containing target association data.             |
| --output-dir  | Directory on the local filesystem to store output data.                     |
| --processes   | Number of processes to use for tasks utilising multiprocessing (default 1). |

### Pipeline Output
The following files are generated by the pipeline in the output directory:

#### `output1.json`
Contains a list of disease-target associations and their associated score metrics.
* `diseaseId`: EMBL-EBI ID of disease* 
* `approvedSymbol`: EMBL-EBI approved symbol for disease
* `targetId`: EMBL-EBI ID of target
* `name`: EMBL-EBI name of target
* `median`: median score
* `top3`: array of top 3 highest scores

#### `output2.txt`
Contains the number of target-target pairs sharing at least two common disease associations.